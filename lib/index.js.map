{"version":3,"sources":["../src/index.ts"],"sourcesContent":["import { Semaphore } from \"@chriscdn/promise-semaphore\";\n\n/**\n * Represents the status of an item processed by {@link asyncEach}.\n *\n * @template T Type of the input item.\n * @template R Type of the result returned by the callback.\n */\nexport type AsyncEachStatus<T, R> = {\n  /**\n   * Number of items completed before the current one.\n   */\n  progress: number;\n\n  /**\n   * Total number of items to process.\n   */\n  total: number;\n\n  /**\n   * Integer percentage of completion in the range 0 to 100.\n   */\n  percent: number;\n\n  /**\n   * The current item being processed.\n   */\n  item: T;\n\n  /**\n   * Index of the current item within the original array.\n   */\n  index: number;\n\n  /**\n   * Result returned by the callback for the current item.\n   */\n  result: R;\n};\n\n/**\n * Callback invoked for each item.\n *\n * @template T Type of the input item.\n * @template R Type of the result returned by the callback.\n * @param item The current item.\n * @param index Index of the current item.\n * @param items The full array of items.\n * @returns A value or promise resolving to the result for the item.\n */\ntype CallbackFn<T, R> = (\n  item: T,\n  index: number,\n  items: Array<T>,\n) => Promise<R> | R;\n\n/**\n * Configuration options for {@link asyncEach}.\n */\ntype Options = {\n  /**\n   * Maximum number of concurrent executions.\n   * If omitted or set to 0, concurrency is unlimited.\n   */\n  rateLimit?: number;\n};\n\n/**\n * Callback invoked after each item is resolved.\n *\n * @template T Type of the input item.\n * @template R Type of the result returned by the callback.\n * @param status Object describing the current processing state.\n */\nexport type AsyncEachStatusCallbackFn<T, R> = (\n  status: AsyncEachStatus<T, R>,\n) => void;\n\n/**\n * Asynchronously iterates over an array of items, invoking a callback for each item.\n * Supports optional concurrency control and per item status reporting.\n *\n * All callbacks are scheduled asynchronously. If any callback rejects or throws,\n * the returned promise rejects immediately with that error.\n *\n * @template T Type of the input items.\n * @template R Type of the result returned by the callback.\n * @param items Array of items to process.\n * @param callbackFn Function invoked for each item. May return a value or a promise.\n * @param statusCallbackFn Optional function invoked after each item resolves.\n * Receives progress information and the result of the current item.\n * @param options Optional configuration. Use rateLimit to restrict concurrency.\n * @returns A promise that resolves with an array of results in the same order\n * as the input items. Rejects if any callback fails.\n */\nconst asyncEach = <T, R>(\n  items: Array<T>,\n  callbackFn: CallbackFn<T, R>,\n  statusCallbackFn: AsyncEachStatusCallbackFn<T, R> = () => {},\n  options: Options = {},\n): Promise<Array<R>> => {\n  let progress: number = 0;\n  const total: number = items.length;\n\n  const rateLimit = options.rateLimit ?? 0;\n  const semaphore = rateLimit > 0 ? new Semaphore(rateLimit) : null;\n\n  const promises = items.map((item: T, index: number, items: Array<T>) => {\n    return new Promise<R>(async (resolve, reject) => {\n      setTimeout(async () => {\n        try {\n          await semaphore?.acquire();\n\n          const result = await callbackFn(item, index, items);\n\n          resolve(result);\n\n          statusCallbackFn({\n            progress: progress++,\n            total,\n            percent: Math.floor((100 * progress) / total),\n            item,\n            index,\n            result,\n          });\n        } catch (err) {\n          reject(err);\n        } finally {\n          semaphore?.release();\n        }\n      }, 0);\n    });\n  });\n\n  // This will reject if any promise fails.\n  return Promise.all(promises);\n};\n\nexport { asyncEach };\n"],"mappings":";AAAA,SAAS,iBAAiB;AA+F1B,IAAM,YAAY,CAChB,OACA,YACA,mBAAoD,MAAM;AAAC,GAC3D,UAAmB,CAAC,MACE;AACtB,MAAI,WAAmB;AACvB,QAAM,QAAgB,MAAM;AAE5B,QAAM,YAAY,QAAQ,aAAa;AACvC,QAAM,YAAY,YAAY,IAAI,IAAI,UAAU,SAAS,IAAI;AAE7D,QAAM,WAAW,MAAM,IAAI,CAAC,MAAS,OAAeA,WAAoB;AACtE,WAAO,IAAI,QAAW,OAAO,SAAS,WAAW;AAC/C,iBAAW,YAAY;AACrB,YAAI;AACF,gBAAM,WAAW,QAAQ;AAEzB,gBAAM,SAAS,MAAM,WAAW,MAAM,OAAOA,MAAK;AAElD,kBAAQ,MAAM;AAEd,2BAAiB;AAAA,YACf,UAAU;AAAA,YACV;AAAA,YACA,SAAS,KAAK,MAAO,MAAM,WAAY,KAAK;AAAA,YAC5C;AAAA,YACA;AAAA,YACA;AAAA,UACF,CAAC;AAAA,QACH,SAAS,KAAK;AACZ,iBAAO,GAAG;AAAA,QACZ,UAAE;AACA,qBAAW,QAAQ;AAAA,QACrB;AAAA,MACF,GAAG,CAAC;AAAA,IACN,CAAC;AAAA,EACH,CAAC;AAGD,SAAO,QAAQ,IAAI,QAAQ;AAC7B;","names":["items"]}