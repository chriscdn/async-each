{"version":3,"file":"async-each.module.js","sources":["../src/index.ts"],"sourcesContent":["import { Semaphore } from \"@chriscdn/promise-semaphore\";\n\nexport type AsyncEachStatus<T, R> = {\n  progress: number;\n  total: number;\n  percent: number;\n  item: T;\n  index: number;\n  result: R;\n};\n\ntype CallbackFn<T, R> = (\n  item: T,\n  index: number,\n  items: Array<T>,\n) => Promise<R> | R;\n\ntype Options = {\n  rateLimit?: number;\n};\n\nexport type AsyncEachStatusCallbackFn<T, R> = (\n  status: AsyncEachStatus<T, R>,\n) => void;\n\nconst asyncEach = <T, R>(\n  items: Array<T>,\n  callbackFn: CallbackFn<T, R>,\n  statusCallbackFn: AsyncEachStatusCallbackFn<T, R> = () => {},\n  options: Options = {},\n): Promise<Array<R>> => {\n  let progress: number = 0;\n  const total: number = items.length;\n\n  const rateLimit = options.rateLimit ?? 0;\n  const semaphore = rateLimit > 0 ? new Semaphore(rateLimit) : null;\n\n  const promises = items.map((item: T, index: number, items: Array<T>) => {\n    return new Promise<R>(async (resolve, reject) => {\n      setTimeout(async () => {\n        try {\n          await semaphore?.acquire();\n\n          const result = await callbackFn(item, index, items);\n\n          resolve(result);\n\n          statusCallbackFn({\n            progress: progress++,\n            total,\n            percent: Math.floor((100 * progress) / total),\n            item,\n            index,\n            result,\n          });\n        } catch (err) {\n          reject(err);\n        } finally {\n          semaphore?.release();\n        }\n      }, 0);\n    });\n  });\n\n  // This will reject if any promise fails.\n  return Promise.all(promises);\n};\n\nexport default asyncEach;\n"],"names":["asyncEach","items","callbackFn","statusCallbackFn","options","_options$rateLimit","progress","total","length","rateLimit","semaphore","Semaphore","promises","map","item","index","Promise","resolve","reject","setTimeout","_temp","acquire","then","result","percent","Math","floor","_catch","err","_finallyRethrows","_wasThrown","_result","release","e","all"],"mappings":"wDAyBM,IAAAA,EAAY,SAChBC,EACAC,EACAC,EACAC,GACqB,IAAAC,WAFrBF,IAAAA,EAAoD,mBACjC,IAAnBC,IAAAA,EAAmB,CAAA,GAEnB,IAAIE,EAAmB,EACjBC,EAAgBN,EAAMO,OAEtBC,EAA6B,OAApBJ,EAAGD,EAAQK,WAASJ,EAAI,EACjCK,EAAYD,EAAY,EAAI,IAAIE,EAAUF,GAAa,KAEvDG,EAAWX,EAAMY,IAAI,SAACC,EAASC,EAAed,GAClD,OAAO,IAAIe,QAAO,SAAWC,EAASC,GAAM,IAsBpC,OArBNC,WAAU,WAAA,QAAYC,kDAChBJ,QAAAC,cACIP,SAAAA,EAAWW,WAASC,KAAAN,WAAAA,OAAAA,QAAAC,QAELf,EAAWY,EAAMC,EAAOd,IAAMqB,cAA7CC,GAENN,EAAQM,GAERpB,EAAiB,CACfG,SAAUA,IACVC,MAAAA,EACAiB,QAASC,KAAKC,MAAO,IAAMpB,EAAYC,GACvCO,KAAAA,EACAC,MAAAA,EACAQ,OAAAA,GACC,EACJ,4DAhBmBI,CAChB,EAeKC,SAAAA,GACPV,EAAOU,EACR,4FAlBmBC,CAAAF,EAkBnB,SAAAG,EAAAC,GACsB,GAArBrB,MAAAA,GAAAA,EAAWsB,UAAUF,EAAAC,MAAAA,EAAAA,OAAAA,CAAA,GAAAf,OAAAA,QAAAC,QAAAG,GAAAA,EAAAE,KAAAF,EAAAE,KAAA,WAAA,QAAA,EAEzB,CAAC,MAAAW,UAAAjB,QAAAE,OAAAe,EAAE,CAAA,EAAA,GAAGjB,QAAAC,SACR,CAAC,MAAAgB,GAAA,OAAAjB,QAAAE,OAAAe,EACH,CAAA,EAAA,GAGA,OAAOjB,QAAQkB,IAAItB,EACrB"}